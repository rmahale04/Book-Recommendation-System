<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ user.username }}'s Profile | NextRead</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0;color:#fff}
    .profile-container{max-width:950px;margin:40px auto;padding:0 20px;animation:fadeInUp .5s ease}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .profile-header{background:#fff;border-radius:20px;padding:25px;display:flex;justify-content:space-between;align-items:center;gap:20px;box-shadow:0 5px 20px rgba(0,0,0,.15);color:#333}
    .profile-info{display:flex;align-items:center;gap:15px}
    .profile-info img{width:90px;height:90px;border-radius:50%;object-fit:cover;border:4px solid #8b5cf6;box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .profile-details h2{margin:0;font-size:28px;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .profile-details p{margin:4px 0;color:#555;font-size:1.1rem}
    .counts{display:flex;gap:20px;margin-top:8px;font-size:1rem}
    .counts span{cursor:pointer;color:#6b21a8;font-weight:600;transition:.2s}
    .counts span:hover{text-decoration:underline}
    .edit-btn{background:#8b5cf6;color:#fff;padding:11px 22px;border-radius:12px;border:none;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(139,92,246,.4);transition:.3s}
    .edit-btn:hover{background:#7c3aed;transform:translateY(-2px)}
    .tabs{display:flex;margin-top:30px;background:transparent;border-bottom:3px solid rgba(255,255,255,.3)}
    .tabs button{flex:1;padding:16px;border:none;background:transparent;cursor:pointer;font-size:17px;font-weight:600;color:rgba(255,255,255,.8);border-bottom:4px solid transparent;transition:.3s}
    .tabs button.active{color:#fff;border-bottom:4px solid #fff}
    .tab-content{display:none;margin-top:25px;padding-bottom:30px}
    .tab-content.active{display:block}
    .about-flex{display:grid;grid-template-columns:0.42fr 0.58fr;gap:22px;margin-top:10px}
    .left-box,.library-section,.friends-grid{background:#fff;padding:22px;border-radius:18px;box-shadow:0 6px 20px rgba(0,0,0,.12);color:#333}
    .left-box h4{margin:0 0 10px;font-size:19px;color:#5b21b6}
    .left-box p{color:#444;line-height:1.6;margin:8px 0}
    .library-grid{margin-top:15px;display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:14px}
    .book-card{background:#f0e6ff;border-radius:14px;overflow:hidden;box-shadow:0 3px 10px rgba(139,92,246,.15);transition:.3s;cursor:pointer}
    .book-card:hover{transform:scale(1.05);box-shadow:0 8px 20px rgba(139,92,246,.3)}
    .book-card img{width:100%;height:150px;object-fit:cover}
    .more-btn{display:inline-block;margin-top:18px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:11px 22px;border-radius:12px;text-decoration:none;font-weight:600;box-shadow:0 4px 15px rgba(139,92,246,.4)}
    .friend-card{background:#f8f5ff;padding:16px;border-radius:16px;display:flex;align-items:center;gap:16px;margin-bottom:14px;box-shadow:0 4px 12px rgba(139,92,246,.1);transition:.3s;cursor:pointer}
    .friend-card:hover{background:#f0e6ff;transform:translateY(-3px)}
    .friend-card img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #e9d5ff}
    .friend-card strong{font-size:1.1rem;color:#333}
    .friend-card small{color:#8b5cf6}
    .no-data{text-align:center;padding:50px 20px;color:#ccc;font-size:1.2rem;font-style:italic}
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .popup-box{width:400px;background:#fff;border-radius:18px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.3);max-height:80vh;overflow-y:auto}
    .popup-box h3{margin-top:0;color:#5b21b6}
    .close-btn{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:#999}
    .popup-list-item{padding:12px 0;border-bottom:1px solid #eee;display:flex;align-items:center;gap:14px}
    .popup-list-item img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  </style>
</head>
<body>
  {% include 'nav_page.html' %}

  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-info">
        <img src="{{ user.profile_image_url or url_for('static', filename='images/default_profile.png') }}" alt="{{ user.username }}">
        <div class="profile-details">
          <h2>{{ user.first_name }} {{ user.last_name }}</h2>
          <p>@{{ user.username }}</p>
          <div class="counts">
            <p><strong>{{ friends|length }} Friends</strong></p>
          </div>
        </div>
      </div>

      {% if session.get('user_id') == user.user_id %}
        <button class="edit-btn" onclick="openSettings()">Settings</button>
      {% endif %}
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-target="about">About</button>
      <button class="tab-btn" data-target="friends">Friends ({{ friends|length }})</button>
      <button class="tab-btn" data-target="ratings">Reviews ({{ reviews|length }})</button>
    </div>

    <!-- ABOUT TAB -->
    <div id="about" class="tab-content active">
      <div class="about-flex">
        <div class="left-box">
          <h4>Bio</h4>
          <p>{{ user.bio or "No bio added yet." }}</p>
          <h4>About Me</h4>
          <p>{{ user.about_me or "No about me added yet." }}</p>
          <h4>Member Since</h4>
          <p>{{ user.join_date.strftime('%B %Y') if user.join_date else "N/A" }}</p>
          <!-- {% if session.get('user_id') == user.user_id %}
            <p style="margin-top:20px;">
              <a href="{{ url_for('edit_profile', username=user.username) }}" style="color:#8b5cf6;font-weight:600;">Edit Profile →</a>
            </p>
          {% endif %} -->
        </div>

        <!-- <div class="library-section">
          <h3 style="margin:0 0 15px;color:#5b21b6;font-size:1.4rem;">Library</h3>
          <div class="library-grid">
            {% if books %}
              {% for book in books %}
                <div class="book-card" onclick="window.location='/book/{{ book.book_id }}'">
                  <img src="{{ book.cover_image_url or url_for('static', filename='images/default_book.png') }}" alt="{{ book.title }}">
                </div>
              {% endfor %}
            {% else %}
              <p class="no-data">No books in library yet.</p>
            {% endif %}
          </div> -->
          <!-- <a class="more-btn" href="/library/{{ user.username }}">View Full Library →</a> -->
        <!-- </div> -->

        <div class="library-section">
          <h3 style="margin:0 0 15px;color:#5b21b6;font-size:1.4rem;">Library</h3>

          {% if shelves %}
              {% for s in shelves %}
                <h3 style="color:#6b21a8;margin:15px 0 10px;">{{ s.name }}</h3>

                {% if s.books %}
                    <div class="library-grid">
                        {% for book in s.books %}
                            <div class="book-card">
                                <img src="{{ book.cover_image_url or url_for('static', filename='images/default_book.png') }}"
                                    onclick="window.location='/book/{{ book.book_id }}'">

                                {% if session.get('user_id') == user.user_id %}
                                    <form method="POST" 
                                          action="{{ url_for('remove_from_shelf', shelf_id=s.shelf_id, book_id=book.book_id) }}">
                                        <button type="submit"
                                                style="margin-top:5px;width:100%;padding:6px;background:#e11d48;color:white;border:none;border-radius:8px;font-size:13px;">
                                            Remove
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-data">No books in this shelf.</p>
                {% endif %}
              {% endfor %}
          {% else %}
              <p class="no-data">No shelves found.</p>
          {% endif %}
        </div>

      </div>
    </div>

    <!-- FRIENDS TAB -->
    <div id="friends" class="tab-content">
      <div class="friends-grid">
        {% if friends %}
          {% for f in friends %}
            <div class="friend-card" onclick="window.location='/profile/{{ f.username }}'">
              <img src="{{ f.profile_image_url or url_for('static', filename='images/default_profile.png') }}" alt="{{ f.username }}">
              <div>
                <strong>{{ f.first_name }} {{ f.last_name }}</strong><br>
                <small>@{{ f.username }}</small>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="no-data">No friends yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- REVIEWS TAB -->
    <div id="ratings" class="tab-content">
      {% if reviews %}
        {% for r in reviews %}
          <div class="friend-card" style="cursor:pointer;background:#fff;" onclick="window.location='/book/{{ r.book_id }}'">
            <img src="{{ r.cover_image_url or url_for('static', filename='images/default_book.png') }}" style="width:70px;height:100px;border-radius:12px;">
            <div style="flex:1;">
              <strong style="font-size:1.15rem;color:#333;">{{ r.title }}</strong><br>
              <small style="color:#888;">by {{ r.author or "Unknown" }}</small>
              <div style="margin:8px 0;font-size:1.5rem;color:#fbbf24;">
                {{ '★' * r.ratings + '☆' * (5 - r.ratings) }}
                <span style="margin-left:10px;font-size:1rem;color:#6b21a8;font-weight:600;">{{ r.ratings }}/5</span>
              </div>
              {% if r.review_text %}
                <p style="color:#444;margin:6px 0;line-height:1.5;font-size:0.95rem;">"{{ r.review_text }}"</p>
              {% endif %}
              <small style="color:#999;">{{ r.review_date.strftime('%b %d, %Y') }}</small>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="no-data">No reviews yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Followers/Following Popup -->
  <div id="popup-overlay" class="popup-overlay">
    <div class="popup-box">
      <span class="close-btn" onclick="closePopup()">×</span>
      <h3 id="popup-title">Followers</h3>
      <div id="popup-list"></div>
    </div>
  </div>

  {% include 'settings_panel.html' %}

  <!-- WORKING JS FOR SETTINGS PANEL -->
  <script>
    // TAB SWITCHING
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // POPUP DATA
    const followers = {{ followers|tojson }};
    const following = {{ following|tojson }};

    function openPopup(type) {
      document.getElementById('popup-overlay').style.display = 'flex';
      document.getElementById('popup-title').innerText = type === 'followers' ? 'Followers' : 'Following';
      const data = type === 'followers' ? followers : following;
      const list = document.getElementById('popup-list');
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No users found.</p>';
        return;
      }
      data.forEach(u => {
        list.innerHTML += `
          <div class="popup-list-item" onclick="window.location='/profile/${u.username}'" style="cursor:pointer;">
            <img src="${u.profile_image_url || '/static/images/default_profile.png'}">
            <div>
              <strong>${u.first_name} ${u.last_name}</strong><br>
              <small style="color:#8b5cf6;">@${u.username}</small>
            </div>
          </div>`;
      });
    }

    function closePopup() {
      document.getElementById('popup-overlay').style.display = 'none';
    }

    // SETTINGS PANEL LOGIC (FULLY WORKING)
    function openSettings() {
      const overlay = document.getElementById("settings-overlay");
      const panel = document.getElementById("settings-panel");

      overlay.style.display = "flex";

      setTimeout(() => panel.classList.add("open"), 10);
    }

    function closeSettings() {
      const overlay = document.getElementById("settings-overlay");
      const panel = document.getElementById("settings-panel");

      panel.classList.remove("open");

      setTimeout(() => overlay.style.display = "none", 300);
    }

    // close when clicking outside
    document.addEventListener("click", function(e){
      const overlay = document.getElementById("settings-overlay");
      const panel = document.getElementById("settings-panel");

      if (overlay.style.display === "flex") {
        if (!panel.contains(e.target) && !e.target.closest(".edit-btn")) {
          closeSettings();
        }
      }
    });
  </script>

</body>
</html>
